<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>Douglas-Fir Beetle Impact on Alaskan Amphibians</title>
    <link href='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css' rel='stylesheet' />

    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        width: 100%;
        top: 0;
        bottom: 0;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <script src="https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.0.6/chroma.min.js"></script>


    <script>
      // create Leaflet map, centered on Alaska
      var map = L.map("map", {
        zoomSnap: 0.1,
        center: [64.2008, -149.4937],
        zoom: 4.5
      });

      // mapbox access token
      var accessToken = "pk.eyJ1IjoicmNyYW1zZXkiLCJhIjoiY2t3M3Fxem5kNXcxbjJubzA2YTBxbTU0eiJ9.R2gez_cyZLVgkYvAs0r4OA";

      // add mapbox tile layers using access token
      L.tileLayer(
        "https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=" +
          accessToken,
        {
          attribution:
            '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>',
            tileSize:512,
            maxZoom: 18,
            zoomOffset: -1,
          id: 'mapbox/light-v10', 
          accessToken: accessToken
        }
      ).addTo(map);

      
        
      
        // hex grid of douglas-fir beetle damage
      d3.json("data/ak-hexgrid.json").then(function(data) {
        // loop through all the hex features and push counts to an array
        const counts = [];

        // loop through the feature data
        data.features.forEach(function(feature) {
          if(feature.properties.count > 0) {
            counts.push(feature.properties.count);
          }
        });

        // request our ampibian data files
        //const newt = d3.json ('data/roughskinnewt4326simpl_precis_topo.json')
        //const toad = d3.json ('data/westerntoad4326simpl_precis_topo.json')

        drawMap(data, counts);
      });

      function drawMap(data, counts) {
        
        console.log(data);
        // // map options
        // var options = {
        //   // style the hexagons
        //   style: function(feature, layer) {
        //     return {
        //       color: "white",
        //       weight: 2,
        //       fillColor: "steelblue",
        //       fillOpacity: 1
        //     };
        //   },
        
         // use chroma.limits to determine
          const breaks = chroma.limits(counts, 'k', 9);

        // build a colorize function
          const colorize = chroma
                          .scale('OrRd')
                          .domain(breaks)
                          .mode('lch')
                          .correctLightness();

        // style the hexagons with data counts
          var options = {
            style: function(feature, layer) {
            return {
              color: 'white',
              weight: 2,
              fillColor: colorize(feature.properties.count),
              fillOpacity: 1
            }
          },

          onEachFeature: function(feature, layer) {
            // attach a tooltip to each
            layer.bindTooltip("# of Douglas-Fir Beetle Damage Incidents: " + feature.properties.count);
          },
          filter: function(feature) {
            if (feature.properties.count) return feature;
          }
        };

        // create the Leaflet map using the hexgrid geojson data
        L.geoJSON(data, options).addTo(map);
      }
    </script>
  </body>
</html>
